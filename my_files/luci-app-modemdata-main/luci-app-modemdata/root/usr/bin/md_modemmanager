#!/bin/sh

#
# (c) 2025 Cezary Jackiewicz <cezary@eko.one.pl>
#
# (c) 2025 modified by Rafa≈Ç Wabik - IceG - From eko.one.pl forum
#

. /lib/functions.sh
. /usr/share/libubox/jshn.sh

ECM=""

RES="/usr/share/modemdata"

device=$1
network=$2
forced_plmn=$3

try_params_mm() {
	local retries=5
	local delay=1
	local i
	local result

	for i in $(seq 1 $retries); do
		result=$($RES/params_modemmanager.sh "$device" "$forced_plmn")
		if [ -n "$result" ]; then
			echo "$result"
			return 0
		fi
		sleep "$delay"
	done
	echo "{}"
}

SEPARATOR=""
parse_section() {
		echo "["
			$RES/product_modemmanager.sh "$device"
			echo ","
			$RES/network.sh "$network"
			echo ","
			try_params_mm
		echo "]"
}

config_load modemdata
parse_section modemdata

exit 0
